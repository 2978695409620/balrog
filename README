Balrog is a rewrite of the Application Update Server used by Mozilla to
provide updates to Firefox. It uses a database to store a series of rules
which map update requests to releases. Documentation is available at
https://wiki.mozilla.org/Balrog.


How to run a Balrog dev environment with Docker:
1) Create Database and App containers:
  docker create --net host -e MYSQL_DATABASE=balrog -e MYSQL_USER=balrogadmin -e MYSQL_PASSWORD=balrogadmin -e MYSQL_ROOT_PASSWORD=admin --name balrog-database -v /var/lib/mysql -it mysql:5.7
  docker create --net host -e DBURI=mysql://balrogadmin:balrogadmin@127.0.0.1/balrog -e SECRET_KEY=blahblah --name balrog-admin -it bhearsum/balrog:latest uwsgi --http :8080 --mount /api=admin.wsgi --manage-script-name --check-static /app/ui/dist --static-index index.html --route "^/.*$ addvar:REMOTE_USER=balrogadmin" --route-if "startswith:\${REQUEST_URI};/api continue:" --route-if-not "exists:/app/ui/dist\${PATH_INFO} static:/app/ui/dist/index.html"
  docker create --net host -e DBURI=mysql://balrogadmin:balrogadmin@127.0.0.1/balrog --name balrog-public -it bhearsum/balrog:latest uwsgi --http :9090 --wsgi-file balrog.wsgi

2) Initialize the Database:
  docker start balrog-database
  # Wait for the database to come up
  sleep 30
  docker run --rm --net host -it bhearsum/balrog:latest python scripts/manage-db.py -d mysql://balrogadmin:balrogadmin@127.0.0.1/balrog create
  docker run --rm --net host -it bhearsum/balrog:latest sh -c 'exec mysql -h 127.0.0.1 -P 3306 -u balrogadmin --password=balrogadmin balrog < sample-data.sql'
  docker run --rm --net host -it bhearsum/balrog:latest sh -c 'exec mysql -h 127.0.0.1 -P 3306 -u balrogadmin --password=balrogadmin -e "insert into permissions (username, permission, data_version) values (\"balrogadmin\", \"admin\", 0);" balrog'

3) Start the apps:
  docker start balrog-admin
  docker start balrog-public

Now you should be able to access the admin interface at:
http://127.0.0.1:8080

And you can access the public interface with URLs such as:
http://127.0.0.1:9090/update/3/Firefox/33.0/20141202185629/Darwin_x86_64-gcc3-u-i386-x86_64/en-US/release/default/default/default/update.xml?force=1

If you're on Mac, Windows, or running Docker in a VM for another reason, you'll need to replace 127.0.0.1 with the IP of your VM.
